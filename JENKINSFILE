pipeline {
  agent any

  stages {

    stage('Get Code') {
      steps {
        cleanWs()
        checkout scm
        bat 'dir'
        echo "WORKSPACE: ${env.WORKSPACE}"
      }
    }

    stage('Static') {
      steps {
        catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
          bat '''
            python -m flake8 --format=pylint app > flake8.out
          '''
        }

        recordIssues(
          tools: [flake8(pattern: 'flake8.out')],
          sourceCodeRetention: 'LAST_BUILD',
          unhealthy: 9, // 10+ => unhealthy (health/weather)
          qualityGates: [[
            criticality: 'UNSTABLE',
            integerThreshold: 8,
            type: 'TOTAL'
          ]]
        )
      }
    }

    
      

        stage('Unit') {
          steps {
           
            catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
              bat '''
                set PYTHONPATH=.
                python -m coverage run --branch --source=app --omit=app\\__init__.py -m pytest --junitxml=result-unit.xml test\\unit
                python -m coverage xml -o coverage.xml
              '''
            }
          }
          post {
            always {
              junit testResults: 'result-unit.xml', skipMarkingBuildUnstable: true, allowEmptyResults: true
              archiveArtifacts artifacts: 'coverage.xml', fingerprint: true
            }
          }
        }

        stage('Rest') {
          steps {
            
            catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
              bat '''
                set FLASK_APP=app\\api.py
                start /B python -m flask run
                start /B java -jar "C:\\cursodevops\\helloworld\\helloworld\\test\\wiremock\\wiremock-standalone-3.13.2.jar" --port 9090 --root-dir "test\\wiremock"

                ping -n 10 127.0.0.1:5000

                pytest --junitxml=result-rest.xml test\\rest
              '''
            }
          }
          post {
            always {
              junit testResults: 'result-rest.xml', skipMarkingBuildUnstable: true, allowEmptyResults: true
            }
          }
        }

      
    

    stage('cobertura') {
      steps {
       
        catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
          recordCoverage(
            tools: [[parser: 'COBERTURA', pattern: 'coverage.xml']],
            qualityGates: [
              // LINE: <85 rojo, 85-95 amarillo, >=95 verde
              [criticality: 'FAILURE',  metric: 'LINE',   threshold: 85.0],
              [criticality: 'UNSTABLE', metric: 'LINE',   threshold: 95.0],

              // BRANCH: <80 rojo, 80-90 amarillo, >=90 verde
              [criticality: 'FAILURE',  metric: 'BRANCH', threshold: 80.0],
              [criticality: 'UNSTABLE', metric: 'BRANCH', threshold: 90.0]
            ]
          )
        }
      }
    }

    stage('Security') {
      steps {
        bat '''
          python -m pip install --upgrade pip
          python -m pip install "bandit[sarif]"
          python -m bandit --exit-zero -r . -f sarif -o bandit.sarif
        '''

        recordIssues(
          tools: [sarif(pattern: 'bandit.sarif')],
          sourceCodeRetention: 'LAST_BUILD',
          unhealthy: 3, // 4+ => unhealthy (health/weather)
          qualityGates: [[
            criticality: 'UNSTABLE',
            integerThreshold: 2,
            type: 'TOTAL'
          ]]
        )
      }
    }

    stage('Performance') {
      steps {
        catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
          bat '''
            set FLASK_APP=app\\api.py
            start /B python -m flask run
            ping -n 10 127.0.0.1

            C:\\cursodevops\\helloworld\\apache-jmeter-5.6.3\\apache-jmeter-5.6.3\\bin\\jmeter -n -t test\\jmeter\\flask.jmx -f -l flask.jtl
            dir flask.jtl
          '''
        }
      }
      post {
        always {
          archiveArtifacts artifacts: 'flask.jtl', fingerprint: true
          perfReport sourceDataFiles: 'flask.jtl'
        }
      }
    }

  }
}
