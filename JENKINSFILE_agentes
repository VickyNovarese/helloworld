pipeline {
  agent any

  stages {

    stage('Get Code') {
      agent { label 'Agente 1' }
      steps {
        bat '''
          echo === CONTEXTO ===
          whoami
          hostname
          echo WORKSPACE=%WORKSPACE%
        '''

        git 'https://github.com/VickyNovarese/helloworld.git'
        bat 'dir'

        stash name: 'src', includes: '**/*'
      }
    }

    stage('Parallel on 3 agents') {
      parallel {

        stage('Static') {
          agent { label 'Agente 1' }
          steps {
            bat '''
              echo === CONTEXTO ===
              whoami
              hostname
              echo WORKSPACE=%WORKSPACE%
            '''

            deleteDir()
            unstash 'src'

            catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
              bat '''
                python -m flake8 --format=pylint app > flake8.out
              '''
            }

            recordIssues(
              tools: [flake8(pattern: 'flake8.out')],
              sourceCodeRetention: 'LAST_BUILD',
              unhealthy: 9,
              qualityGates: [[
                criticality: 'UNSTABLE',
                integerThreshold: 8,
                type: 'TOTAL'
              ]]
            )
          }
        }

        stage('Tests + Coverage (Agent B)') {
          agent { label 'Agente 2' }
          stages {

            stage('Unit') {
              steps {
                bat '''
                  echo === CONTEXTO ===
                  whoami
                  hostname
                  echo WORKSPACE=%WORKSPACE%
                '''

                deleteDir()
                unstash 'src'

                catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                  bat '''
                    set PYTHONPATH=.
                    python -m coverage run --source=app --omit=app\\__init__.py -m pytest --junitxml=result-unit.xml test\\unit
                    python -m coverage xml -o coverage.xml
                  '''
                }
              }
              post {
                always {
                  junit testResults: 'result-unit.xml', skipMarkingBuildUnstable: true, allowEmptyResults: true
                  archiveArtifacts artifacts: 'coverage.xml', fingerprint: true
                }
              }
            }

            stage('Rest') {
              steps {
                bat '''
                  echo === CONTEXTO ===
                  whoami
                  hostname
                  echo WORKSPACE=%WORKSPACE%
                '''

                catchError(buildResult: 'SUCCESS', stageResult: 'SUCCESS') {
                  bat '''
                    set FLASK_APP=app\\api.py
                    start /B python -m flask run
                    start /B java -jar "C:\\cursodevops\\helloworld\\helloworld\\test\\wiremock\\wiremock-standalone-3.13.2.jar" --port 9090 --root-dir "test\\wiremock"
                    ping -n 10 127.0.0.1:5000
                    pytest --junitxml=result-rest.xml test\\rest
                  '''
                }
              }
              post {
                always {
                  junit testResults: 'result-rest.xml', skipMarkingBuildUnstable: true, allowEmptyResults: true
                }
              }
            }

            stage('Coverage Gates') {
              steps {
                bat '''
                  echo === CONTEXTO ===
                  whoami
                  hostname
                  echo WORKSPACE=%WORKSPACE%
                '''

                // Aunque marque rojo, que el pipeline siga
                catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                  recordCoverage(
                    tools: [[parser: 'COBERTURA', pattern: 'coverage.xml']],
                    qualityGates: [
                      [criticality: 'FAILURE',  metric: 'LINE',   threshold: 85.0],
                      [criticality: 'UNSTABLE', metric: 'LINE',   threshold: 95.0],
                      [criticality: 'FAILURE',  metric: 'BRANCH', threshold: 80.0],
                      [criticality: 'UNSTABLE', metric: 'BRANCH', threshold: 90.0]
                    ]
                  )
                }
              }
            }
          }
        }

        stage('Security + Performance (Agent C)') {
          agent { label 'Agente 3' }
          stages {

            stage('Security') {
              steps {
                bat '''
                  echo === CONTEXTO ===
                  whoami
                  hostname
                  echo WORKSPACE=%WORKSPACE%
                '''

                deleteDir()
                unstash 'src'

                bat '''
                  python -m pip install --upgrade pip
                  python -m pip install "bandit[sarif]"
                  python -m bandit --exit-zero -r . -f sarif -o bandit.sarif
                '''

                recordIssues(
                  tools: [sarif(pattern: 'bandit.sarif')],
                  sourceCodeRetention: 'LAST_BUILD',
                  unhealthy: 3,
                  qualityGates: [[
                    criticality: 'UNSTABLE',
                    integerThreshold: 2,
                    type: 'TOTAL'
                  ]]
                )
              }
            }

            stage('Performance') {
              steps {
                bat '''
                  echo === CONTEXTO ===
                  whoami
                  hostname
                  echo WORKSPACE=%WORKSPACE%
                '''

                catchError(buildResult: 'UNSTABLE', stageResult: 'UNSTABLE') {
                  bat '''
                    set FLASK_APP=app\\api.py
                    start /B python -m flask run
                    ping -n 10 127.0.0.1

                    C:\\cursodevops\\helloworld\\apache-jmeter-5.6.3\\apache-jmeter-5.6.3\\bin\\jmeter -n -t test\\jmeter\\flask.jmx -f -l flask.jtl
                    dir flask.jtl
                  '''
                }
              }
              post {
                always {
                  archiveArtifacts artifacts: 'flask.jtl', fingerprint: true
                  perfReport sourceDataFiles: 'flask.jtl'
                }
              }
            }
          }
        }

      }
    }
  }
}

